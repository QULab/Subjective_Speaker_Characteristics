---
title: "Factor analysis of speaker characteristics"
author: "Laura Fernández Gallardo"
date: "June 2017"
bibliography: references.bib
output: 
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Perform factor analysis to reduce the 34-dimensional subjective speaker attributions to a smaller set of dimensions. Factor analysis instead of PCA in order to extract latent factors that represent the space of perceived interpersonal speaker characteristics from voice.

More details in @my29.


## 1) Load subjective ratings

Clear workspace.

```{r message=FALSE}

rm(list=ls())

```

Load necessary libraries.

```{r message=FALSE, warning=FALSE}

library(RCurl) # to read raw data from repo
library(GPArotation) 
library(psych) # for alpha analysis

```

Set paths and read data.

```{r echo=FALSE}

setwd_thisdir <- function () {
  this.dir <- dirname(parent.frame(3)$ofile)
  setwd(this.dir)
}

path_generated_data <- paste0(setwd_thisdir,"../data/generated_data")

path_github <- "https://raw.githubusercontent.com/laufergall/Subjective_Speaker_Characteristics/master/data/subjective_ratings"
  
data_raw <- read.csv(text=getURL(paste0(path_github,"/SC_ratings.csv")), header=TRUE, sep=",")  

```

## 2) Factor analysis for each speaker gender

Split data into male and female speakers to perform factor analysis separately, as males and females have different stereotypes. 

```{r}

data_split_g <- split(data_raw, data_raw$speaker_gender)
data_m <- data_split_g$male
data_f <- data_split_g$female

```

### 2a) Factor analysis of male speakers

```{r}

# always use z-scores
data_m <- data_m[order(data_m$listener_pseudonym),]
data_m<- cbind(data_m[,c(1, 5)], data.frame(do.call("rbind", as.list(by(data_m[,10:ncol(data_m)], data_m$listener_pseudonym, scale)))))
data_m <- data_m[order(data_m$listener_pseudonym),]

# find the no of factors
fa.parallel(data_m[,3:ncol(data_m)])

```

Parallel analysis suggests that the number of factors =  7  and the number of components =  4 . Hence, perform factor analysis with 7 factors:

```{r}
fa_m <- fa(data_m[,3:ncol(data_m)], nfactors=7 , rotate="oblimin", fm="minres") # this is default; no pricipal axis analysis

print(fa_m, cut=.2, digits=2, sort=T)

```

In order to only retain items with large main loading and small cross-loadings, we remove items when main loading <= .5  && (main loading - cross-loading) <= .2.

```{r}

## Second round: Run factor analysis again, removing items:

itemsremove <- c("emotional", "gesellig", "charakterlos", "intelligent", "aktiv", "bescheiden", "dominant", "unaufdringlich", "maennlich", "entspannt", "gleichgueltig", "gelangweilt", "unaffektiert", "aufgesetzt", "unsachlich", "inkompetent")
intemsremoveindexes <- match( itemsremove, colnames(data_m))

data_m_02 <- data_m[ ,-intemsremoveindexes ]

names(data_m_02)

fa.parallel(data_m_02[,3:ncol(data_m_02)])
# Parallel analysis suggests that the number of factors =  5  and the number of components =  3 

fa_m_02 <- fa(data_m_02[,3:ncol(data_m_02)], nfactors=5 , rotate="oblimin", fm="minres") # this is default; no pricipal axis analysis
print(fa_m_02, cut=.2, digits=2, sort=T)

```


Examine alphas to see if we should remove other items. 

```{r}

# Dimension 1 -  MR1
alpha(as.data.frame(cbind(
  data_m_02$herzlich, data_m_02$mitfuehlend, data_m_02$distanziert, data_m_02$freundlich, data_m_02$verstaendnislos, data_m_02$unsympatisch, data_m_02$nicht.genervt)
),check.keys=TRUE)
# raw_alpha = 0.88. no item removed

# Dimension 2 -  MR4
alpha(as.data.frame(cbind(
  data_m_02$attraktiv, data_m_02$haesslich, data_m_02$interessant, data_m_02$angenehm)
),check.keys=TRUE)
# raw_alpha = 0.84. no item removed

# Dimension 3 -  MR2
alpha(as.data.frame(cbind(
  data_m_02$sicher, data_m_02$unentschieden)
),check.keys=TRUE)
# raw_alpha = 0.78. no item removed


# Dimension 4 -  MR5
alpha(as.data.frame(cbind(
  data_m_02$gehorsam, data_m_02$zynisch)
),check.keys=TRUE)
# raw_alpha = 0.78. no item removed


# Dimension 5 -  MR3
alpha(as.data.frame(cbind(
  data_m_02$alt, data_m_02$kindlich, data_m_02$ruhig)
),check.keys=TRUE)
# raw_alpha = 0.63
alpha(as.data.frame(cbind(
  data_m_02$alt, data_m_02$kindlich)
),check.keys=TRUE)
# raw_alpha = 0.76


```


Compute new factor scores as a weighted average of the z-scores.

```{r}

loa_m <- fa_m_02$loadings
loa_m_df <- as.data.frame(loa_m[,])


fs_m_dim1 <- loa_m_df["herzlich",1]*data_m$herzlich + 
  loa_m_df["mitfuehlend",1]*data_m$mitfuehlend + 
  loa_m_df["distanziert",1]*data_m$distanziert + 
  loa_m_df["freundlich",1]*data_m$freundlich + 
  loa_m_df["verstaendnislos",1]*data_m$verstaendnislos + 
  loa_m_df["unsympathisch",1]*data_m$unsympathisch + 
  loa_m_df["nicht_genervt",1]*data_m$nicht_genervt

fs_m_dim2 <- loa_m_df["attraktiv",2]*data_m$attraktiv + 
  loa_m_df["haesslich",2]*data_m$haesslich + 
  loa_m_df["angenehm",2]*data_m$angenehm + 
  loa_m_df["interessant",2]*data_m$interessant


fs_m_dim3 <- loa_m_df["sicher",3]*data_m$sicher + 
  loa_m_df["unentschieden",3]*data_m$unentschieden 

fs_m_dim4 <- loa_m_df["gehorsam",4]*data_m$gehorsam + 
  loa_m_df["zynisch",4]*data_m$zynisch

fs_m_dim5 <- loa_m_df["alt",5]*data_m$alt + 
  loa_m_df["kindlich",5]*data_m$kindlich

```

Write scores to file.

```{r}

factorscores_m <- data.frame("sample_heard"=data_m$sample_heard, "dim1"=fs_m_dim1, "dim2"=fs_m_dim2, "dim3"=fs_m_dim3, "dim4"=fs_m_dim4, "dim5"=fs_m_dim5)

factorscores_m_averaged <- aggregate(factorscores_m[,2:ncol(factorscores_m)], by=list(factorscores_m$sample_heard), mean, na.rm=T)
names(factorscores_m_averaged)[1] <- "sample_heard"

write.csv(factorscores_m_averaged, paste0(path_generated_data, "/factorscores_malespk.csv"), row.names = F)

```





### 2b) Factor analysis of male speakers

## 3) Summary of dimensions and loadings



